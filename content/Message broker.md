## Message broker

#### 1. Опыт работы с брокерами сообщений
Существуют два самых популярных брокера сообщений. Kafka и RabbitMQ
#### 2. Плюсы и минусы брокеров сообщений
**Плюсы**:
- *Асинхронность*: Службы могут работать независимо друг от друга.
- *Масштабируемость*: Легко увеличивать количество потребителей.
- *Надежность*: Сообщения не теряются благодаря механизмам повторных попыток и подтверждений.
- *Разделение нагрузки*: Потребители могут обрабатывать сообщения параллельно.

**Минусы**:
- *Сложность настройки*: Требует правильной конфигурации для эффективной работы.
- *Задержка*: Добавление брокера увеличивает задержку доставки сообщений.
- *Поддержка инфраструктуры*: Нужны усилия для мониторинга и администрирования.

#### 3. Опыт работы с Kafka
-

#### 4. Опыт работы с RabbitMQ
-

#### 5. Разница между Kafka и RabbitMQ
- **Модели сообщений**
  - *Kafka*. Сообщения не удаляются после доставки
  - *RabbitMQ*. Сообщения удаляются после доставки

- **Обработка сообщений**
  - *Kafka*. Потребители сами запрашивают сообщения из топиков, читая их по мере необходимости
  - *RabbitMQ*. Сообщения пушатся к потребителям из очереди, когда те готовы их принять (следовательно сервер может лечь, если данных данных слишком много)

- **Производительность**
  - *Kafka* быстрее и производительнее чем *RabbitMQ*(за счет partition-ов + горизонтальное масштабирование)

#### 6. Что такое топик в Kafka?
*Топик* - это канал передачи информации определенного типа. Каждый топик в свою очередь разделен на partition-ы

#### 7. Что такое Producer и что такое Consumer?
- *Producer* - компонент, отправляющий сообщения (данные) в Kafka
- *Consumer* - компонент, получающий сообщения из Kafka

#### 8. Что такое partition в Kafka?
Это подразделение топика, в котором хранятся сообщения. По default-у сообщения будут закидываться в разные partition-ы, что увеличивает скорость обмена сообщениями между микросервисами, но при этом нет гарантии очередности доставки сообщений. Если нам надо, что бы какие-то сообщения приходили в строгой очередности - для этого существует ключ partition-ов, который позволяет объединить сообщения в очередь в конкретном partition-е

#### 9. Гарантии доставки в Kafka
- *At least once*. Гарантия того, что сообщение будет доставлено по крайней мере один раз, либо больше. 
- *At most once*. Гарантия того, что сообщение будет доставлено максимум один раз, либо не будет доставлено вовсе
- *Exactly once*. Гарантия того, что сообщение будет доставлено ровно один раз. Это наиболее строгий уровень гарантии и требует согласованности между producer-ом и consumer-ом, чтобы избежать дублирования сообщений

#### 10. Какие паттерны работы с очередями?
- **Point-to-Point (P2P)**: Один продюсер, один потребитель. Сообщение читается одним потребителем и удаляется из очереди.
- **Publish-Subscribe (Pub/Sub)**: Один продюсер отправляет сообщение нескольким подписчикам через обменники.
- **Work Queue**: Несколько потребителей обрабатывают сообщения из одной очереди, распределяя нагрузку.
- **Dead Letter Queue (DLQ)**: Очередь для сообщений, которые не удалось обработать.
- **Priority Queue**: Сообщения обрабатываются в зависимости от их приоритета.

#### 11. Основные компоненты Kafka?
*Apache Kafka* — это распределённая система обработки потоков, состоящая из нескольких ключевых компонентов:

- *Producer* (Производитель) — отправляет данные в Kafka.
- *Consumer* (Потребитель) — получает данные из Kafka.
- *Topics* (Топики) — логическая сущность, разделяющая данные на каналы. Каждый топик хранит сообщения в порядке их поступления.
- *Partitions* (Партиции) — подмножества топиков, которые разделяют данные для их распределенного хранения и параллельной обработки. Партиции дают возможность хранить данные на разных серверах.
- *Broker* (Брокер) — сервер, ответственный за хранение данных в Kafka.
- *ZooKeeper* — служит для управления и координации брокеров, поддерживает метаданные системы. Однако в новых версиях Kafka можно использовать KRaft (Kafka Raft), который заменяет ZooKeeper.
- *Consumer Group* (Группа потребителей) — объединение консьюмеров, которые параллельно обрабатывают данные одного топика. Каждый консьюмер в группе обрабатывает разные партиции топика, что улучшает параллельность и производительность.

#### 12. Ситуация. 3 машины в кафке и одна упала. Что с нашей инфой? Инфа постарадает?
Если в кластере Kafka три машины (брокера), то у нас есть репликация данных.

Для обеспечения надёжности Kafka поддерживает фактор репликации для каждой партиции (обычно это 2 или 3). При падении одного брокера Kafka использует оставшиеся реплики для восстановления информации. **Важно**:

>- Если настройка фактора репликации совпадает с числом брокеров, данные сохранятся, и консьюмеры смогут продолжить работу с оставшимися брокерами.
>- Если фактор репликации меньше числа брокеров, часть данных может оказаться утерянной, если единственный брокер с этой репликой выйдет из строя.

Таким образом, при правильной настройке репликации (фактор >= 2) информация сохраняется.

#### 13. Kafka. Консьюмер группа
*Consumer Group* — это механизм для группировки консьюмеров, работающих с одним топиком, для:

- *Распределения нагрузки*: каждый консьюмер из группы читает данные только из одной или нескольких партиций, избегая дублирования. Например, если у нас три партиции и три консьюмера в группе, каждый из них будет работать с одной партицией.
- *Гибкости*: можно масштабировать количество консьюмеров в группе для более быстрой обработки данных.

Консьюмеры внутри группы координируются так, что каждое сообщение обрабатывается ровно одним консьюмером в группе, что обеспечивает гарантию «один раз» для сообщений.
